<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PKCE OAuth Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Load configuration from external file (not committed to git) -->
  <script src="./test-pkce-config.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .status {
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      background: #f0f0f0;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 10px 5px;
      cursor: pointer;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>üîê PKCE OAuth Flow Test</h1>
  
  <!-- Configuration Notice -->
  <div class="status info" style="margin-bottom: 20px;">
    <strong>‚ö†Ô∏è Configuration Required:</strong><br>
    Before testing, copy <code>test-pkce-config.example.js</code> to <code>test-pkce-config.js</code> 
    and replace the placeholder values with your actual Supabase credentials.
    See the example file for instructions.
  </div>
  
  <div id="status" class="status info">
    Ready to test PKCE flow
  </div>

  <button onclick="testPKCEFlow()">Test Google OAuth (PKCE)</button>
  <button onclick="checkSessionStorage()">Check SessionStorage</button>
  <button onclick="clearStorage()">Clear Storage</button>

  <div id="output"></div>

  <script>
    // Load Supabase configuration from external config file
    // Configuration is loaded from test-pkce-config.js (not committed to git)
    // If config is not found, show error with instructions
    if (typeof TEST_SUPABASE_CONFIG === 'undefined') {
      document.getElementById('status').innerHTML = `
        <div class="status error">
          <strong>‚ùå Configuration Missing!</strong><br>
          Please create <code>test-pkce-config.js</code> by copying <code>test-pkce-config.example.js</code> 
          and adding your Supabase credentials.
        </div>
      `;
      document.querySelectorAll('button').forEach(btn => btn.disabled = true);
      throw new Error('TEST_SUPABASE_CONFIG not found. Please create test-pkce-config.js');
    }

    // Validate required properties exist
    if (!TEST_SUPABASE_CONFIG.url || !TEST_SUPABASE_CONFIG.anonKey) {
      document.getElementById('status').innerHTML = `
        <div class="status error">
          <strong>‚ùå Invalid Configuration!</strong><br>
          Please ensure <code>test-pkce-config.js</code> includes both 'url' and 'anonKey' properties.
        </div>
      `;
      document.querySelectorAll('button').forEach(btn => btn.disabled = true);
      throw new Error('Missing required config properties: url and/or anonKey');
    }

    const SUPABASE_URL = TEST_SUPABASE_CONFIG.url;
    const SUPABASE_ANON_KEY = TEST_SUPABASE_CONFIG.anonKey;

    // Debug/Verbose Logging Configuration
    // ‚ö†Ô∏è WARNING: Set to false in production to prevent logging sensitive data (tokens, codes, etc.)
    // When true: Logs full authorization codes, tokens, and detailed OAuth data
    // When false: Only logs success/failure without sensitive values
    const VERBOSE_LOGGING = false;

    // Validate configuration
    if (SUPABASE_URL === 'YOUR_SUPABASE_PROJECT_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
      document.getElementById('status').innerHTML = `
        <div class="status error">
          <strong>‚ùå Invalid Configuration!</strong><br>
          Please update <code>test-pkce-config.js</code> with your actual Supabase credentials.
        </div>
      `;
      document.querySelectorAll('button').forEach(btn => btn.disabled = true);
      throw new Error('Invalid credentials. Please update test-pkce-config.js');
    }

    // Create Supabase client with PKCE
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        flowType: 'pkce',
        persistSession: true,
        storage: window.sessionStorage,
        detectSessionInUrl: true,
      }
    });

    function log(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
      console.log(`[${type.toUpperCase()}]`, message);
    }

    function displayOutput(title, data) {
      const output = document.getElementById('output');
      
      // Sanitize sensitive data if verbose logging is disabled
      let displayData = data;
      if (!VERBOSE_LOGGING && data) {
        displayData = JSON.parse(JSON.stringify(data)); // Deep clone
        
        // Redact sensitive fields
        if (displayData.code) {
          displayData.code = '[REDACTED - Enable VERBOSE_LOGGING to view]';
        }
        if (displayData.accessToken) {
          displayData.accessToken = '[REDACTED - Enable VERBOSE_LOGGING to view]';
        }
        if (displayData.access_token) {
          displayData.access_token = '[REDACTED - Enable VERBOSE_LOGGING to view]';
        }
        if (displayData.refresh_token) {
          displayData.refresh_token = '[REDACTED - Enable VERBOSE_LOGGING to view]';
        }
        if (displayData.session?.access_token) {
          displayData.session.access_token = '[REDACTED - Enable VERBOSE_LOGGING to view]';
        }
        if (displayData.session?.refresh_token) {
          displayData.session.refresh_token = '[REDACTED - Enable VERBOSE_LOGGING to view]';
        }
      }
      
      output.innerHTML = `
        <h3>${title}</h3>
        <pre>${JSON.stringify(displayData, null, 2)}</pre>
      `;
    }

    async function testPKCEFlow() {
      try {
        log('Initiating Google OAuth with PKCE...', 'info');
        
        const { data, error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: window.location.origin + '/test-pkce-client.html',
            queryParams: {
              access_type: 'offline',
              prompt: 'consent',
            },
          },
        });

        if (error) {
          log(`Error: ${error.message}`, 'error');
          displayOutput('Error Details', error);
          return;
        }

        log('Redirecting to Google... Check Network tab for code_challenge parameter', 'success');
        displayOutput('OAuth Data', data);
        
        // The user will be redirected, so this won't execute
      } catch (error) {
        log(`Exception: ${error.message}`, 'error');
        displayOutput('Exception Details', error);
      }
    }

    function checkSessionStorage() {
      const storage = {};
      for (let i = 0; i < sessionStorage.length; i++) {
        const key = sessionStorage.key(i);
        if (key && (key.includes('supabase') || key.includes('pkce') || key.includes('auth'))) {
          try {
            const value = JSON.parse(sessionStorage.getItem(key));
            // Redact sensitive values unless verbose logging is enabled
            if (!VERBOSE_LOGGING && value) {
              if (typeof value === 'object') {
                const sanitized = JSON.parse(JSON.stringify(value));
                if (sanitized.access_token) sanitized.access_token = '[REDACTED]';
                if (sanitized.refresh_token) sanitized.refresh_token = '[REDACTED]';
                if (sanitized.currentSession?.access_token) {
                  sanitized.currentSession.access_token = '[REDACTED]';
                }
                if (sanitized.currentSession?.refresh_token) {
                  sanitized.currentSession.refresh_token = '[REDACTED]';
                }
                storage[key] = sanitized;
              } else {
                storage[key] = value;
              }
            } else {
              storage[key] = value;
            }
          } catch {
            storage[key] = sessionStorage.getItem(key);
          }
        }
      }

      if (Object.keys(storage).length === 0) {
        log('No auth-related items in sessionStorage', 'info');
        displayOutput('SessionStorage', { message: 'Empty or no auth items' });
      } else {
        const itemCount = Object.keys(storage).length;
        const verboseNote = VERBOSE_LOGGING ? '' : ' (sensitive values redacted - set VERBOSE_LOGGING=true to view)';
        log(`Found ${itemCount} auth-related items in sessionStorage${verboseNote}`, 'success');
        displayOutput('SessionStorage Contents', storage);
      }
    }

    function clearStorage() {
      sessionStorage.clear();
      log('SessionStorage cleared', 'success');
      document.getElementById('output').innerHTML = '';
    }

    // Handle OAuth callback
    window.addEventListener('load', async () => {
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const queryParams = new URLSearchParams(window.location.search);
      
      const code = queryParams.get('code');
      const accessToken = hashParams.get('access_token');

      if (code) {
        // Log authorization code reception without exposing the actual code (unless verbose logging is enabled)
        if (VERBOSE_LOGGING) {
          log('‚úÖ PKCE FLOW DETECTED! Authorization code received: ' + code.substring(0, 20) + '...', 'success');
          console.log('[DEBUG] Full authorization code:', code);
        } else {
          log('‚úÖ PKCE FLOW DETECTED! Authorization code received successfully.', 'success');
        }
        
        displayOutput('OAuth Callback (PKCE)', {
          flow: 'PKCE',
          code: code,
          message: 'This is correct! You are using PKCE flow.'
        });
        
        // Exchange code for session
        try {
          const { data, error } = await supabase.auth.exchangeCodeForSession(code);
          if (error) {
            log('Code exchange failed: ' + error.message, 'error');
          } else {
            log('Code exchange successful!', 'success');
            displayOutput('Session Data', data);
          }
        } catch (e) {
          log('Code exchange error: ' + e.message, 'error');
        }
      } else if (accessToken) {
        // Log implicit flow detection without exposing the token (unless verbose logging is enabled)
        if (VERBOSE_LOGGING) {
          log('‚ùå IMPLICIT FLOW DETECTED! Access token in URL hash: ' + accessToken.substring(0, 20) + '...', 'error');
          console.log('[DEBUG] Access token detected:', accessToken.substring(0, 20) + '...');
        } else {
          log('‚ùå IMPLICIT FLOW DETECTED! Access token found in URL hash.', 'error');
        }
        
        displayOutput('OAuth Callback (Implicit)', {
          flow: 'Implicit',
          accessToken: accessToken.substring(0, 20) + '...',
          message: 'This is NOT correct for PKCE. You are using implicit flow.'
        });
      }
    });
  </script>
</body>
</html>
